function TableEditor(){}TableEditor.prototype={options:{tableIdentifier:'div.table',headerIdentifier:'div.header',rowIdentifier:'div.row',columnIdentifier:'div.column, div.firstColumn',initialize:0,minRowSliderCount:20,scrollTimeout:200,snapHeader:true,verticalSlider:true},allSelected:false,tables:[],date:new Date(),timed:null,window:$(window),document:$(document),scrollTop:0,actionCallback:[],init:function(options){var that=this;if(options){$.each(options,function(key,value){that.options[key]=value})}$(this.options.tableIdentifier).each(function(){var table=$(this);that.initializeTable(table);that.tables[that.tables.length]=table});if(that.tables.length&&that.options.snapHeader){that.window.scroll(function(){if(that.timed)clearTimeout(that.timed);if($.browser.msie){that.timed=setTimeout(function(){that.onScrollEnd()},that.options.scrollTimeout)}else{that.timed=setTimeout(function(thisObj){thisObj.onScrollEnd()},that.options.scrollTimeout,that)}})}return this},initializeTable:function(table){var that=this;this.attachInputElements(table);if($.browser.mozilla){table.bind('click',function(event){var target=event.target;var element=$(target);var type=target.localName;var pe=(type=='option')?$(target.parentNode):element;var peType=pe.attr('type');var column=pe.parent();var row=column.parent();if(type=='option'){that.replicateData(table,row,column,pe.attr('type'),target.value)}else if(peType=='checkbox'){that.replicateData(table,row,column,pe.attr('type'),target.checked)}})}table.selectable({filter:that.options.rowIdentifier,selected:function(event,ui){that.cleanup(table);if(!$.browser.mozilla){that.attachCheckboxElementsInRow(table,ui.selected)}that.attachSelectElementsInRow(table,ui.selected);that.attachDatepickerOnChangeInRow(table,ui.selected)},unselected:function(event,ui){that.detachColumnHandlers(ui.unselected)}});this.addSelectAllButton(table);this.resizeTableColumns(table);this.attachActionHandlers(table)},registerActionCallback:function(name,callback){this.actionCallback[name]=callback},attachActionHandlers:function(table){var that=this;$('[action]',table).each(function(){var action=$(this);var id=(action.attr('identifier'))?action.attr('identifier'):'';action.bind('click',function(){that.handleAction(action.attr('action'),id,table)})})},handleAction:function(callbackFunctionName,id,table){var ids=[];var exists=false;var callback=this.actionCallback[callbackFunctionName];$('.ui-selected, .table-editor-selected',table).each(function(){var row=$(this);var rowId=row.attr('identifier');if(rowId){ids[ids.length]=rowId;if(rowId==id)exists=true}});if(callback){if(ids.length&&exists){callback.call(ids)}else if(id){callback.call([id])}}},attachInputElements:function(table){var that=this;table.bind('keyup.tableEditor',function(e){var element=$('input:focus,select:focus');var type=element.attr('type');if(element.attr('type')){var column=element.parent();var row=element.parent().parent();var value=element.val();that.replicateData(table,row,column,type,value)}})},attachSelectElementsInRow:function(table,row){var that=this;$('select',row).each(function(){var element=$(this);var type='select';var column=element.parent();var row=element.parent().parent();element.bind('change.tableEditor',function(){var value=$('option:selected',element).val();if(value)that.replicateData(table,row,column,type,value)})})},attachCheckboxElementsInRow:function(table,row){var that=this;$('input:checkbox',row).each(function(){var element=$(this);var type='checkbox';var column=element.parent();var row=element.parent().parent();element.bind('click.tableEditor',function(){that.replicateData(table,row,column,type,element.is(':checked'))})})},attachDatepickerOnChangeInRow:function(table,row){var that=this;$("input[type=text][rel$='date'], input[type=text][rel$='datetime']",row).each(function(){var element=$(this);var type=element.attr('type');var column=element.parent();var row=element.parent().parent();element.bind('change.tableEditor',function(){that.replicateData(table,row,column,type,element.val())})})},detachColumnHandlers:function(row){if(!this.allSelected){$("select, input[type=text][rel$='date'], input[type=text][rel$='datetime'], input:checkbox",row).each(function(){$(this).unbind('.tableEditor')})}},getColumnNumber:function(row,column){var count=0;var columnNumber=0;row.children().each(function(){var childColumn=$(this);if(childColumn[0]==column[0]){columnNumber=count}count++});return columnNumber},replicateData:function(table,row,column,type,value){var that=this;var columnNumber=this.getColumnNumber(row,column);var inputSelector="";if(!type)return;switch(type){case('text'):inputSelector='input';break;case('select'):case('select-one'):inputSelector='select';break;case('checkbox'):inputSelector='input:checkbox';break;default:inputSelector='input';break}if(inputSelector=='select'){var selectedIndex=$(inputSelector,$(that.options.columnIdentifier,row)[columnNumber])[0].selectedIndex}if(row.hasClass('ui-selected')||row.hasClass('table-editor-selected')){$('.ui-selected, .table-editor-selected',table).each(function(){if($(this)[0]!=row[0]){$(inputSelector,$(that.options.columnIdentifier,$(this))[columnNumber]).each(function(){switch(type){case('checkbox'):$(this).attr('checked',value);break;case('select'):$(this)[0].options[selectedIndex].selected=true;break;default:$(this).val(value);break}})}})}},addSelectAllButton:function(table){var that=this;var selectAllElement=$($(this.options.headerIdentifier+':eq(0)',table).find(':nth-child(1)')[0]);if(selectAllElement){selectAllElement.addClass('selectAll').html('&nbsp;&nbsp;&nbsp;').bind('mousedown',function(){that.selectAll(table)});selectAllElement.qtip({content:'leftMiddle',position:{corner:{tooltip:'leftMiddle',target:'rightMiddle'}},style:{border:{width:5,radius:10},padding:10,textAlign:'center',tip:true,name:'blue'},content:"Click to select all rows in this table",show:'mouseover',hide:'mouseout',api:{beforeShow:function(){}}})}},selectAll:function(table){var that=this;$(this.options.rowIdentifier,table).each(function(){var row=$(this);if(!row.hasClass('table-editor-selected'))row.addClass('table-editor-selected');that.detachColumnHandlers(row);if(!$.browser.mozilla){that.attachCheckboxElementsInRow(table,row)}that.attachSelectElementsInRow(table,row);that.attachDatepickerOnChangeInRow(table,row)});this.allSelected=true},cleanup:function(table){if(this.allSelected){this.deselectAll(table);this.allSelected=false}},deselectAll:function(table){var that=this;$(this.options.rowIdentifier,table).each(function(){var row=$(this);row.removeClass('table-editor-selected');if(!$.browser.mozilla){that.detachColumnHandlers(row)}});this.allSelected=false},resizeTableColumns:function(table){var header=$(this.options.headerIdentifier,table);var width=20;var column=0;var columns=[];var resized=[];header.children().each(function(){var c=$(this);var columnWidth=c.outerWidth(true);width+=columnWidth;resized[column]=(c.attr('rel')=='resized');columns[column]=c.width();column++});if(header.parent().css('width').replace("px","")<width){header.css({width:width+'px'})}$(this.options.rowIdentifier,table).each(function(){var row=$(this);var column=0;row.children().each(function(){var child=$(this);child.css({width:columns[column]+'px'});if(resized[column]){$(':input',child).each(function(){$(this).css({width:(columns[column]-10)+'px'})})}column++});if(row.parent().css('width').replace("px","")<width){row.css({width:width+'px'})}});if(header.width()>table.width()){if(this.options.verticalSlider){this.addVerticalSlider(table)}else{if($(this.options.rowIdentifier,table).size()>this.options.minRowSliderCount)this.addSlider(table,'before');this.addSlider(table,'after')}}},addSlider:function(table,location){var that=this;var header=$(this.options.headerIdentifier,table);var sliderContainer=$(document.createElement('div'));sliderContainer.addClass('sliderContainer');if(location=='before'){table.before(sliderContainer)}else if(location=='after'){table.after(sliderContainer)}sliderContainer.slider({value:1,min:1,max:header.width()-table.width(),step:1,slide:function(event,ui){$(that.options.headerIdentifier+', '+that.options.rowIdentifier,table).css({'margin-left':(1-ui.value)+'px'})}})},addVerticalSlider:function(table){var that=this;var header=$(this.options.headerIdentifier,table);var sliderContainer=$(document.createElement('div')).addClass('verticalSliderContainer');var max=header.width()-table.width();table.before(sliderContainer);sliderContainer.slider({orientation:"vertical",value:max,min:1,max:max,step:1,slide:function(event,ui){$(that.options.headerIdentifier+', '+that.options.rowIdentifier,table).css({'margin-left':(0-(max-ui.value))+'px'})}})},onScrollEnd:function(){var that=this;var time=this.date.getTime();var top=this.window.scrollTop();var bottom=top+this.window.height();var direction=(top>this.scrollTop)?'down':'up';if(top>this.scrollTop||top<this.scrollTop){this.scrollTop=top;for(var i in that.tables){var table=that.tables[i];var offset=table.offset();var tableTop=offset.top;var tableBottom=tableTop+table.height();var header=$(that.options.headerIdentifier,table);if(tableTop<=bottom&&tableBottom>=top){var topRow=null;var topRowNo=0;var headerNo=0;var count=0;$(that.options.rowIdentifier+", "+that.options.headerIdentifier,table).each(function(){var row=$(this);var rowTop=row.offset().top;var rowBottom=rowTop+row.height();count++;if(!topRow&&((rowTop>=top&&rowTop<=bottom))){topRow=row;topRowNo=count}if(row[0]==header[0])headerNo=count});if(topRow){if(headerNo==topRowNo){}else if(headerNo>topRowNo){topRow.before(header);if(that.options.verticalSlider)that.repositionVerticalSlider(table,header)}else if(headerNo<topRowNo){topRow.after(header);if(that.options.verticalSlider)that.repositionVerticalSlider(table,header)}}}}}},repositionVerticalSlider:function(table,header){var slider=table.prev();slider.animate({top:header.offset().top},200)}}