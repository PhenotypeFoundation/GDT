/**
 *  Ontology Chooser, use any NCBO ontology with a text input element
 *  Copyright (C) 2010 Jeroen Wesbeek
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function OntologyChooser(){}OntologyChooser.prototype={cache:[],ctrl:false,noSearch:false,clipboard:[],options:{minLength:1,showHide:null,spinner:"http://www.ajaxload.info/images/exemples/2.gif"},init:function(e){var t=this;if(e){$.each(e,function(e,n){t.options[e]=n})}if(this.options.showHide){this.options.showHide.hide()}$("input[rel*='ontology']").each(function(){t.initAutocomplete(this)})},initAutocomplete:function(e){var t=this;var n=$(e);var r=false;var i=n.attr("rel").split("-");var s=i[1];var o=i[2];if(s=="all"){s=""}n.bind("keydown",function(e){if(e.keyCode==17||e.keyCode==224)t.ctrl=true;if(e.keyCode==13)return false;if(e.keyCode==8&&t.options.showHide)t.options.showHide.hide();if(e.keyCode==67&&t.ctrl)return t.copy(n);if(e.keyCode==86&&t.ctrl)return t.paste(n)});n.bind("keyup",function(e){if(e.keyCode==17||e.keyCode==224)t.ctrl=false});n.autocomplete({minLength:t.options.minLength,delay:300,search:function(e,i){if(t.noSearch){t.noSearch=false;return false}if(t.options.spinner){n.css({background:"url("+t.options.spinner+") no-repeat right center"})}r=false},source:function(e,r){var i=$.trim(e.term);var o="http://bioportal.bioontology.org/search/json_search/"+s+"?q="+e.term+"&response=json&callback=?";if(t.cache[i]){n.css({background:"none"});r(t.cache[i])}else{$.getJSON(o,function(e){var o=t.parseData(e.data,s);t.cache[i]=o;n.css({background:"none"});if(!e.data){if(t.options.showHide)t.options.showHide.hide();t.setInputValue(n,"concept_id",null);t.setInputValue(n,"ontology_id",null);t.setInputValue(n,"ncbo_id",null);t.setInputValue(n,"full_id",null)}r(o)})}},select:function(e,i){r=true;var s=n;t.setInputValue(s,"concept_id",i.item.concept_id);t.setInputValue(s,"ontology_id",i.item.ontology_id);t.setInputValue(s,"ncbo_id",i.item.ncbo_id);t.setInputValue(s,"full_id",i.item.full_id);s.removeClass("error");if(t.options.showHide){t.options.showHide.show()}},close:function(e,i){if(!r){var s=n;n.val("");t.setInputValue(s,"concept_id","");t.setInputValue(s,"ontology_id","");t.setInputValue(s,"ncbo_id","");t.setInputValue(s,"full_id","");s.addClass("error")}},html:true})},setInputValue:function(e,t,n){var r=e.attr("name")+"-"+t;var i=e.parent().find("input[name='"+r+"']");if(i.size()>0){$(i[0]).val(n)}else{e.after('<input type="hidden" name="'+r+'" value="'+n+'"/>')}},getInputValue:function(e,t){var n=e.attr("name")+"-"+t;var r=e.parent().find("input[name='"+n+"']");return r.size()>0?$(r[0]).val():""},parseData:function(e,t){var n=[];var r=e.split("~!~");for(var i=0;i<r.length;i++){var s=$.trim(r[i]);if(s){var o=s.split("|");var u;if(o.length>8){u=o[8]}else{u=t}n[n.length]={value:o[0],label:o[0]+' <span class="about">('+o[2]+')</span> <span class="from">from: '+o[o.length-2]+"</span>",preferred_name:o[0],concept_id:o[1],ontology_id:o[3],full_id:o[4],ncbo_id:u}}}return n},copy:function(e){this.clipboard={sourceValue:$(e).val(),concept_id:this.getInputValue(e,"concept_id"),ontology_id:this.getInputValue(e,"ontology_id"),ncbo_id:this.getInputValue(e,"ncbo_id"),full_id:this.getInputValue(e,"full_id")};return false},paste:function(e){if(this.clipboard.sourceValue&&this.clipboard.concept_id&&this.clipboard.ncbo_id&&this.clipboard.full_id){var t=new RegExp(this.clipboard.ncbo_id);if(e.attr("rel").match(t)||e.attr("rel").match(/all/)){this.noSearch=true;$(e).val(this.clipboard.sourceValue);this.setInputValue(e,"concept_id",this.clipboard.concept_id);this.setInputValue(e,"ontology_id",this.clipboard.ontology_id);this.setInputValue(e,"ncbo_id",this.clipboard.ncbo_id);this.setInputValue(e,"full_id",this.clipboard.full_id)}}return false}}